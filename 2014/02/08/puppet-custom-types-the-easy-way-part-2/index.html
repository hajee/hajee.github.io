
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Puppet Custom Types, the easy way (part 2) - People & Software</title>
  <meta name="author" content="Bert Hajee">
  <meta name="twitter:widgets:csp" content="on">

  
  <meta name="description" content="The easy way to building Puppet Custom Types with easy_type (part 2)">
  <meta name="keywords" content="devops, continuous deployment, infastructure puppet, easy_type, ruby">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://hajee.github.io/2014/02/08/puppet-custom-types-the-easy-way-part-2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="People & Software" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,400italic' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-45679728-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">People & Software</a></h1>
  <h2>My ramblings on people using software</h2>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss email">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
    <li><a href="http://eepurl.com/LOXpn" rel="subscribe-email" title="subscribe via email">Email</a></li>
  
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Puppet Custom Types, the Easy Way (Part 2)</h1>
    
  </header>




<span class="categories">
  
    <a class='category' href='/blog/categories/devops/'>devops</a>, <a class='category' href='/blog/categories/puppet/'>puppet</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>
  
</span>


<div class="entry-content"><p>In the <a href="/2014/01/26/puppet-custom-types-the-easy-way/">last blog post</a>, we started with our own custom type. We added the <code>easy_type</code> module, created the files necessary for getting started and got our custom running without any errors. We then added two lines to get into a state where Puppet was able to do an inventory of our systems. But a custom type not able to create, delete or modify the state of your system, wouldnt be very helpful. So in the blog post we are going to add that functionality to our custom_package type.</p>

<!-- more -->


<h2>Let&rsquo;s recap</h2>

<p>Let&rsquo;s first look back at what we did last time. To get started with <a href="https://github.com/hajee/easy_type">easy_type</a>, we made sure <code>easy_type</code> is installed in the module path. We used <code>librarian-puppet</code> to get <code>easy_type</code> installed. After that,  we created the right directories and created a scaffold. Since the last blog post,  we have added the scaffold to the <code>easy_type</code>. This makes&rsquo;s it even easier to get started. To get it, use the next command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>cp -Rv easy_type/scaffold custom_package/lib/puppet
</span></code></pre></td></tr></table></div></figure>


<p>After we created the scaffold, we checked what puppet would do with the type and noticed <code>Puppet</code> didn&rsquo;t do anything, but also didn&rsquo;t complain. So a good start.</p>

<p>Then we added the 2 lines of code for getting the raw package information from the system. After that,  we added the 1 line of code that picked the name and version information from the raw package information. Then we had a working Puppet custom type.</p>

<p><img src="/images/custom_package_list.png" title="Index from custom_package" ></p>

<p>Wel working&hellip;Sort of. Because the type doesn&rsquo;t know yet how it can create, delete and modify resources. So that&rsquo;s what we&rsquo;re going to do next.</p>

<h2>How to create a resource in real life?</h2>

<p>Like I said in the <a href="/2014/01/26/puppet-custom-types-the-easy-way/">last blog post</a>, a design goal of <code>easy_type</code> is to let you focus on the resource knowledge and let us do the Puppet stuff. So what is needed to create a new <code>custom_package</code> instance. To create a new <code>custom_package</code> instance, we need to install a package.</p>

<p>For <code>easy_type</code>,  it would be the easiest thing if we could use the same base command as we used to get an index. That would be the <code>rpm</code> command, but in this case the best way to install a package is a <code>yum</code> command.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>yum -q install a_package
</span></code></pre></td></tr></table></div></figure>


<p>This would install the latest version. But what if we needed a specific version? Then <code>a_package</code> needs to be both the name and the version number, concatenated with a dash. For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>yum -q install php-5.2.6-2
</span></code></pre></td></tr></table></div></figure>


<p>Will install php version 5.2.6-2</p>

<h2>And how to do it in the Puppet world?</h2>

<p>So how do we get this knowledge into our own custom type? First we have to add the extra command (<code>yum</code>) that is used. We do this by changing the <code>set_command</code> line to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set_command</span> <span class="o">[</span><span class="ss">:rpm</span><span class="p">,</span> <span class="ss">:yum</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>This line tells <code>easy_type</code> that we use <code>rpm</code> and <code>yum</code> as commands. Next we have to tell <code>easy_type</code> to use <code>yum</code> when we need to create a resource:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">on_create</span> <span class="k">do</span> <span class="o">|</span><span class="n">command_builder</span><span class="o">|</span>
</span><span class='line'>  <span class="n">command_builder</span><span class="o">.</span><span class="n">add</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">yum</span> <span class="s2">&quot;install -y </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>But wait. What about the version number? Don&rsquo;t we need to do add it somewhere? And you are right. We need to add it at the definition of the property. At the property add the lines:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">on_apply</span> <span class="k">do</span> <span class="o">|</span><span class="n">command_builder</span><span class="o">|</span>
</span><span class='line'>  <span class="n">command_builder</span><span class="o">.</span><span class="n">append</span> <span class="k">do</span>
</span><span class='line'>    <span class="s2">&quot;-</span><span class="si">#{</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The method is only run when we need to create a resource or when the attribute value in the manifest is different from the attribute value on the system. So in this case, because we create a resource the method is called. With the <code>append</code> method, we tell the <code>command_builder</code> to add some text to the string created before by the <code>command_builder.add</code>.</p>

<p>So now we are able to create a <code>custom_package</code> resource.</p>

<p><img src="/images/custom_package_created.png" title="Install a package using custom_package type" ></p>

<h2>And now some destruction</h2>

<p>Like we saw before, <code>yum</code> is the command used to install a package. <code>yum</code> is also used to uninstall a package and therefore delete a resource in the Puppet world. The command will be:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>yum -q erase a_package
</span></code></pre></td></tr></table></div></figure>


<p>To get this wisdom into our custom type, we need to add some code to the <code>on_destroy</code> handler.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">on_destroy</span> <span class="k">do</span> <span class="o">|</span> <span class="n">command_builder</span><span class="o">|</span>
</span><span class='line'>  <span class="n">command_builder</span><span class="o">.</span><span class="n">add</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">yum</span> <span class="s2">&quot;erase -y </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So besides indexing and creating, now our custom type is also ready for to destroy a resource.</p>

<p><img src="/images/custom_package_destroy.png" title="Install a package using custom_package type" ></p>

<h2>How about modifying?</h2>

<p>Like we did before, we want to focus on our knowledge of the resource. What do we do when we modify the version attribute?</p>

<blockquote><p>The on_modify handler is a naive implementation that does not handle downgrade properly. The correct implementation should compare against the installed software version and invoke package downgrade when appropriate. The code here is kept simple; for more complete examples, see the ~/src/puppet/lib/puppet/provider/packages directory.</p><footer><strong>Just like in the book Puppet Types and providers</strong></footer></blockquote>


<p>So in our simple case, we just install the specified version. Actually we just do an <code>on_create</code>. So let&rsquo;s tell our type to behave like that.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">on_modify</span> <span class="k">do</span> <span class="o">|</span> <span class="n">command_builder</span><span class="o">|</span>
</span><span class='line'>  <span class="n">on_create</span><span class="p">(</span><span class="n">command_builder</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So now when we change the version number, a different package is installed.</p>

<p><img src="/images/custom_package_modified.png" title="Install a package using custom_package type" ></p>

<h2>AND TA TAAHH</h2>

<p>Now we are ready. We have a Custom Puppet Type that has the ability to:</p>

<ul>
<li>Do an index</li>
<li>create a new resource</li>
<li>destroy/delete a resource</li>
<li>and modify an existing resource</li>
</ul>


<p>If we don&rsquo;t count the  boiler plate code, then we added just 18 lines of code to get this working. Not to bad.</p>

<h2>There&rsquo;s a lot more</h2>

<p>Like I said in the introduction, this is really a simple example. Real life custom types are more difficult. So <code>easy_type</code> has some more functionality that is not shown in this examples.</p>

<ul>
<li>support for standard mungers</li>
<li>support for standard validators</li>
<li>A lot of tricks in the command_builder so it&rsquo;s easy to build commands based on what Puppet thinks, needs to be done.</li>
<li>support for extracting the definition of attributes and properties</li>
</ul>


<p>If you would like to see more about <code>easy_type</code>, just let me know and I will see if we can do some more posts about it. For now, check the example source in the <a href="https://github.com/hajee/my_own_easy_type">github repository</a>. You can also check some <a href="https://github.com/hajee/oracle">Oracle Custom Types</a> which are build upon <code>easy_type</code>.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Bert Hajee</span></span>

      








  


<time datetime="2014-02-08T13:57:20+01:00" pubdate data-updated="true">Feb 8<span>th</span>, 2014</time>
    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://hajee.github.io/2014/02/08/puppet-custom-types-the-easy-way-part-2/" data-via="bhajee" data-counturl="http://hajee.github.io/2014/02/08/puppet-custom-types-the-easy-way-part-2/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2014/01/26/puppet-custom-types-the-easy-way/" title="Previous Post: Puppet Custom Types, the easy way">&laquo; Puppet Custom Types, the easy way</a>
      
      
        <a class="basic-alignment right" href="/2014/02/23/using-puppet-to-manage-oracle/" title="Next Post: Using Puppet to manage Oracle">Using Puppet to manage Oracle &raquo;</a>
      
    </p>
  </footer>
</article>

<article class="archives">
  <div class="related-posts">
    <h2>Related Posts</h2>
    
      <article>
        <h3 class="title"><a href="/2014/09/26/review-of-the-book-mastering-puppet/">Review of the book Mastering Puppet</a></h3>
        <div class="meta">
            
        </div>
      </article>
    
      <article>
        <h3 class="title"><a href="/2014/06/26/pietros-puppet-pizza-place-1/">Learning Puppet at the Puppet Pizza Place</a></h3>
        <div class="meta">
            
        </div>
      </article>
    
  </div>
</article>


  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    
<section>
  <h1>About me</h1>
  <ul id="my_info">
      <li class="gravator">
				<img src="http://www.gravatar.com/avatar/3d00c6d5e4c56164f44f1fc96a1027ef?s=150" alt="Gravatar of Bert Hajee " title="Gravatar of Bert Hajee" />
      </li>
      <li class="name">
        <a href="/about">Bert Hajee</a>
      </li>
  </ul>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2014/09/26/review-of-the-book-mastering-puppet/">Review of the book Mastering Puppet</a>
      </li>
    
      <li class="post">
        <a href="/2014/06/26/pietros-puppet-pizza-place-1/">Learning Puppet at the Puppet Pizza Place</a>
      </li>
    
      <li class="post">
        <a href="/2014/02/23/using-puppet-to-manage-oracle/">Using Puppet to manage Oracle</a>
      </li>
    
      <li class="post">
        <a href="/2014/02/08/puppet-custom-types-the-easy-way-part-2/">Puppet Custom Types, the easy way (part 2)</a>
      </li>
    
      <li class="post">
        <a href="/2014/01/26/puppet-custom-types-the-easy-way/">Puppet Custom Types, the easy way</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/hajee">@hajee</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'hajee',
            count: 5,
            skip_forks: false,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Bert Hajee -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'hajee';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://hajee.github.io/2014/02/08/puppet-custom-types-the-easy-way-part-2/';
        var disqus_url = 'http://hajee.github.io/2014/02/08/puppet-custom-types-the-easy-way-part-2/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/javascripts/aharris.js"></script>

</body>
</html>
